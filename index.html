<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Content Hub</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/styles/main.css">
    <style>
        /* General body styles are in main.css */
        /* These styles are specific to the layout of index.html */
        body {
            /* font-family is inherited from main.css */
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden; /* Prevent body scrollbars */
            /* transition for margin-left is here, background/color transitions are in main.css */
            transition: margin-left 0.3s ease-in-out; 
        }

        #sidebar-toggle-btn {
            position: fixed; /* Or absolute if sidebar is the parent */
            top: 10px;
            left: 10px; /* Initial position */
            z-index: 1001; /* Above sidebar */
            background-color: var(--button-background);
            color: var(--button-text);
            border: 1px solid var(--border-color); /* Use var for border */
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 16px;
            transition: left 0.3s ease-in-out, background-color 0.3s ease, color 0.3s ease;
        }

        #sidebar {
            width: 250px;
            min-width: 250px; /* Prevent it from shrinking too much during transition */
            background-color: var(--sidebar-background);
            color: var(--sidebar-text); /* Added text color for sidebar */
            padding: 20px;
            padding-top: 50px; /* Space for the toggle button if it were inside */
            overflow-y: auto;
            border-right: 1px solid var(--border-color);
            height: 100%;
            position: fixed; /* Changed to fixed for proper off-screen sliding */
            left: 0;
            top: 0;
            z-index: 1000;
            transform: translateX(0);
            transition: transform 0.3s ease-in-out, background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        #sidebar.sidebar-collapsed {
            transform: translateX(-100%);
            border-right: none; /* Hide border when collapsed */
        }

        #content-area {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto; /* Keep this if content within iframe might scroll */
            height: 100%;
            margin-left: 270px; 
            transition: margin-left 0.3s ease-in-out;
            display: flex; /* Make content-area a flex container */
            flex-direction: column; /* Stack children vertically */
            box-sizing: border-box; /* Ensure padding is included in height calculation */
            background-color: var(--background-color); /* Ensure content area also uses theme */
        }

        body.sidebar-collapsed #content-area {
            margin-left: 20px; /* Adjust as needed, or 0 if toggle button moves with content */
        }
        
        body.sidebar-collapsed #sidebar-toggle-btn {
            left: 10px; /* Keep button visible */
        }

        #toc-container h2 {
            margin-top: 0;
            color: var(--sidebar-text); /* Theme TOC header */
        }
        #navigation-area h3 {
             color: var(--sidebar-text); /* Theme Navigation header */
        }


        #home-content { /* Added style for home-content */
            flex-grow: 1; /* Allow home-content to fill available space in content-area */
            position: relative; 
        }

        #home-content iframe { /* More specific selector and adjusted height */
            width: 100%;
            height: 100%; /* Fill the #home-content div */
            border: 1px solid var(--iframe-border-color);
            box-sizing: border-box;
        }

        .hidden {
            display: none;
        }
        #navigation-area button.active {
            background-color: var(--secondary-color); /* Use a theme variable */
            font-weight: bold;
            /* color will be var(--button-text) or overridden if needed */
        }
        #theme-toggle-btn { /* Style for the new theme toggle button */
            display: block; /* Make it take full width in its container */
            width: calc(100% - 16px); /* Adjust width considering padding */
            margin: 10px auto; /* Center it and add some margin */
            padding: 10px;
            /* background-color, color, border are inherited from general button styles or overridden by main.css vars */
        }

        /* Quality Control Report Styles */
        #qc-report-container {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            max-width: 400px;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            display: none;
        }

        #qc-report-header {
            padding: 10px;
            background: var(--secondary-bg-color);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #qc-report-content {
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }

        #qc-report-summary {
            margin-bottom: 10px;
            font-weight: bold;
        }
    </style>
    </head>
<body>
    <!-- Quality Control Report Section -->
    <div id="qc-report-container" style="position: fixed; top: 10px; right: 10px; z-index: 1000; max-width: 400px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); font-family: 'Monaco', 'Consolas', monospace; font-size: 12px; display: none;">
        <div id="qc-report-header" style="padding: 10px; background: var(--secondary-bg-color); border-bottom: 1px solid var(--border-color); cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
            <span style="font-weight: bold;">üìä Quality Control Report</span>
            <span id="qc-toggle-icon" style="transform: rotate(0deg); transition: transform 0.3s ease;">‚ñº</span>
        </div>
        <div id="qc-report-content" style="padding: 10px; max-height: 300px; overflow-y: auto; display: none;">
            <div id="qc-report-summary" style="margin-bottom: 10px; font-weight: bold;"></div>
            <div id="qc-report-details"></div>
        </div>
    </div>

    <button id="sidebar-toggle-btn">‚ò∞</button>
    <!-- Quality Control will be loaded dynamically to avoid path conflicts -->
    <script>
        // Authentication Check and Redirection
        (function() {
            // console.log("Checking authentication status..."); // Log can be removed or kept
            const isAuthenticated = sessionStorage.getItem('isAuthenticated');
            if (isAuthenticated !== 'true') {
                // Optional: Store the page they were trying to access to redirect back later
                // sessionStorage.setItem('redirectUrl', window.location.pathname + window.location.search);
                window.location.href = 'login.html';
            }
        })();
    </script>

    <div id="sidebar">
        <div> <!-- Wrapper for theme button -->
            <button id="theme-toggle-btn">Toggle Theme</button>
        </div>
        <hr>
        <div id="search-container" style="padding: 10px 0;">
            <input type="search" id="toc-search" placeholder="Search content..." style="width: 100%; box-sizing: border-box; padding: 8px;">
        </div>
        <hr>
        <div id="toc-container">
            <h2>Table of Contents</h2>
            <div id="dynamic-toc-content">
                <!-- toc.html will be loaded here -->
                <p>Loading Table of Contents...</p> 
            </div>
            <!-- Removed extra closing div from here -->
        </div>
    </div>
    <div id="content-area">
        <div id="home-content">
            <!-- Iframe will be created here by JavaScript -->
        </div>
    </div>

    <script>
        // Import the content diagnostics system
        let contentDiagnostics;
        
        // Initialize diagnostics when DOM is ready
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Load the diagnostics module
                const diagnosticsModule = await import('./src/content-diagnostics.js');
                window.ContentLoadingDiagnostics = diagnosticsModule.default || diagnosticsModule.ContentLoadingDiagnostics;
                contentDiagnostics = new window.ContentLoadingDiagnostics();
                window.contentDiagnostics = contentDiagnostics;
                console.log('‚úÖ Content diagnostics system initialized');
            } catch (error) {
                console.warn('‚ö†Ô∏è Could not load diagnostics module, using fallback:', error.message);
                // Create a minimal fallback
                contentDiagnostics = {
                    loadContentWithDiagnostics: window.loadContent,
                    log: (msg, level) => console.log(`[Fallback] ${msg}`)
                };
            }
        });

        // Enhanced core function to load content into the iframe
        window.loadContent = async function(pageUrl, buttonElementToActivate) {
            // Use diagnostics system if available, otherwise fallback
            if (contentDiagnostics && contentDiagnostics.loadContentWithDiagnostics) {
                return await contentDiagnostics.loadContentWithDiagnostics(pageUrl, buttonElementToActivate);
            }
            
            // Fallback implementation
            const homeContentDiv = document.getElementById('home-content');
            if (!homeContentDiv) {
                console.error('Home content area (home-content) not found.');
                return false;
            }

            const navButtons = document.querySelectorAll('#navigation-area button');
            navButtons.forEach(btn => btn.classList.remove('active'));

            if (buttonElementToActivate) {
                buttonElementToActivate.classList.add('active');
            }

            let iframe = homeContentDiv.querySelector('iframe');
            if (!iframe) {
                iframe = document.createElement('iframe');
                iframe.id = 'content-iframe';
                iframe.style.cssText = 'width: 100%; height: 100%; border: none; background: white; min-height: 500px;';
                
                // Enhanced error handling for iframe loading
                iframe.onerror = function() {
                    console.error('Failed to load content:', pageUrl);
                    const errorHtml = `
                        <html><body style="font-family: Arial; padding: 20px; text-align: center;">
                            <h3>Content not available</h3>
                            <p>Unable to load: ${pageUrl}</p>
                            <button onclick="window.location.reload()">Retry</button>
                        </body></html>
                    `;
                    iframe.src = 'data:text/html;charset=utf-8,' + encodeURIComponent(errorHtml);
                };
                
                // Improved iframe load handling
                iframe.onload = function() {
                    console.log('‚úÖ Content loaded:', pageUrl);
                    try {
                        // Enhanced cross-origin error suppression
                        if (iframe.contentWindow) {
                            iframe.contentWindow.addEventListener('error', function(e) {
                                console.warn('üîá Iframe error suppressed:', e.message);
                                return true;
                            });
                        }
                    } catch (e) {
                        // Cross-origin restrictions - this is expected and normal
                    }
                };
                
                homeContentDiv.innerHTML = ''; 
                homeContentDiv.appendChild(iframe);
            }
            
            // Validate and set URL
            if (pageUrl && pageUrl.trim() && !pageUrl.includes('<') && !pageUrl.includes('javascript:')) {
                console.log('üîÑ Loading:', pageUrl);
                
                // Pre-flight check
                try {
                    const response = await fetch(pageUrl, { method: 'HEAD' });
                    if (response.ok) {
                        iframe.src = pageUrl;
                        return true;
                    } else {
                        console.error('‚ùå File not found:', pageUrl, response.status);
                        iframe.src = `data:text/html,<html><body style="font-family: Arial; padding: 20px; text-align: center;"><h3>File Not Found</h3><p>${pageUrl} (HTTP ${response.status})</p></body></html>`;
                        return false;
                    }
                } catch (error) {
                    console.error('‚ùå Network error:', error.message);
                    iframe.src = `data:text/html,<html><body style="font-family: Arial; padding: 20px; text-align: center;"><h3>Network Error</h3><p>${error.message}</p></body></html>`;
                    return false;
                }
            } else {
                console.error('Invalid page URL:', pageUrl);
                iframe.src = `data:text/html,<html><body style="font-family: Arial; padding: 20px; text-align: center;"><h3>Invalid URL</h3><p>Invalid URL provided: ${pageUrl || 'undefined'}</p></body></html>`;
                return false;
            }
        };

        // Function for static navigation buttons in the sidebar
        window.showContent = function(pageKey) {
            // This function is now effectively deprecated as static nav buttons are removed.
            // However, it's kept for potential future use or if any part of the app still calls it.
            // The default page load is handled by the 'Initial page load logic' block.
            console.warn('window.showContent is deprecated. Navigation should occur via TOC.', pageKey);
            // Default behavior could be to load the first item from TOC or a specific known page.
            // For now, let's make it load the introduction page if 'home' is requested.
            if (pageKey === 'home') {
                 // Attempt to find "INTRODUCTION" in toc.html and load it
                const introLink = document.querySelector('#dynamic-toc-content a[href*="introduction/page.html"]');
                if (introLink && introLink.href) {
                    window.loadContentIntoIframe(introLink.getAttribute('href'), introLink);
                } else {
                     // Fallback if intro link not found, load a default known page from EXPRESS.
                     // This should ideally match one of the preferredOrder items.
                     window.loadContentIntoIframe('EXPRESS/introduction/page.html', null);
                }
            } else if (pageKey === 'test') { // 'test' key is also deprecated
                 // Attempt to find "COMPREHENSIVE STORAGE TEST" in toc.html and load it
                const testLink = document.querySelector('#dynamic-toc-content a[href*="comprehensive-storage-test/index.html"]');
                if (testLink && testLink.href) {
                    window.loadContentIntoIframe(testLink.getAttribute('href'), testLink);
                } else {
                    window.loadContentIntoIframe('EXPRESS/comprehensive-storage-test/index.html', null);
                }
            } else {
                console.warn('showContent called with unknown or unhandled pageKey:', pageKey);
            }
        };

        // Function called by toc.html links (e.g., parent.loadContentIntoIframe('path/to/page.html', this))
        window.loadContentIntoIframe = function(pageUrl, tocLinkElement) {
            // Simple routing with history management
            const route = extractRouteFromUrl(pageUrl);
            const newUrl = new URL(window.location);
            newUrl.hash = route;
            window.history.pushState({ page: pageUrl, route: route }, '', newUrl);
            
            window.loadContent(pageUrl, null); 
            sessionStorage.setItem('currentPage', pageUrl);
        };
        
        // Helper function to extract route from URL
        function extractRouteFromUrl(url) {
            // Convert EXPRESS/section/page.html to #/section
            let route = url.replace(/^EXPRESS\//, '').replace(/\/index\.html$/, '').replace(/\/page\.html$/, '');
            if (!route || route === url) {
                // Fallback for other patterns
                const parts = url.split('/').filter(part => part && part !== 'EXPRESS');
                route = parts.length > 0 ? parts.join('/') : 'home';
            }
            return route;
        }
        
        // Enhanced handle URL routing for direct access and browser navigation
        async function handleRouting() {
            // Simple routing without complex router dependency
            const hash = window.location.hash.slice(1); // Remove # 
            if (!hash) {
                return false; // No hash to process
            }
            
            console.log('üîç Processing URL hash:', hash);
            
            // Try to find content based on hash with more comprehensive path mapping
            const possiblePaths = [
                `EXPRESS/${hash}/index.html`,     // Try index.html first (most common)
                `EXPRESS/${hash}/page.html`,      // Then page.html
                `EXPRESS/${hash}.html`            // Finally direct .html file
            ];
            
            // Try each possible path sequentially and wait for responses
            for (const path of possiblePaths) {
                try {
                    console.log('üîç Trying path:', path);
                    const response = await fetch(path, { method: 'HEAD' });
                    if (response.ok) {
                        console.log('‚úÖ Found content at:', path);
                        const success = await window.loadContent(path, null);
                        if (success) {
                            sessionStorage.setItem('currentPage', path);
                            return true;
                        }
                    }
                } catch (error) {
                    // Continue to next path
                    console.debug(`Path not accessible: ${path}`, error.message);
                }
            }
            
            console.log('‚ùå No content found for hash:', hash);
            return false;
        }

        // Enhanced navigation event handlers
        window.addEventListener('hashchange', async function() {
            console.log('üîÑ Hash changed, handling routing...');
            await handleRouting();
        });
        
        // Handle initial routing if URL has hash
        if (window.location.hash) {
          setTimeout(async () => {
            console.log('üîÑ Initial hash detected, handling routing...');
            await handleRouting();
          }, 100);
        }

        // Handle browser back/forward buttons
        window.addEventListener('popstate', function(event) {
            if (event.state && event.state.page) {
                window.loadContent(event.state.page, null);
                sessionStorage.setItem('currentPage', event.state.page);
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            // Theme Toggle Functionality
            const themeToggleButton = document.getElementById('theme-toggle-btn');
            // const body = document.body; // Define body inside DOMContentLoaded or pass to applyTheme
            // const iframe = document.querySelector('#home-content iframe'); // Get iframe reference early

            function applyTheme(theme) {
                // Ensure document.body is available before proceeding.
                if (!document.body) { 
                    console.error('Theme application (DOMContentLoaded): document.body is not available.');
                    return; 
                }
                // If document.documentElement is also styled by this function, check it too:
                // if (!document.documentElement) {
                //     console.error('Theme application (DOMContentLoaded): document.documentElement is not available.');
                //     return;
                // }

                const newTheme = theme === 'dark' ? 'dark' : 'light';

                // Apply to body
                if (newTheme === 'dark') {
                    document.body.classList.add('dark-theme');
                } else {
                    document.body.classList.remove('dark-theme');
                }
                
                // If you also want to manage classes on document.documentElement from here:
                // For example, if the main.css expects html.dark-theme for some global styles
                if (document.documentElement) {
                   if (newTheme === 'dark') {
                       document.documentElement.classList.add('dark-theme'); // Optional: if your CSS uses html.dark-theme
                   } else {
                       document.documentElement.classList.remove('dark-theme'); // Optional
                   }
                }

                localStorage.setItem('theme', newTheme);

                const contentIframe = document.querySelector('#home-content iframe');
                if (contentIframe && contentIframe.contentWindow) {
                    contentIframe.contentWindow.postMessage({ type: 'themeChange', theme: newTheme }, '*');
                }
            }

            // Initial theme application based on localStorage (MOVED HERE - though already here, adding try/catch)
            try {
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme) {
                    applyTheme(savedTheme);
                } else {
                    applyTheme('light'); // Default
                }
            } catch (e) {
                console.warn('Failed to apply theme from localStorage on DOMContentLoaded (root index.html):', e);
                applyTheme('light'); // Fallback
            }

            themeToggleButton.addEventListener('click', function() {
                const currentTheme = localStorage.getItem('theme') === 'dark' ? 'dark' : 'light';
                applyTheme(currentTheme === 'dark' ? 'light' : 'dark');
            });

            /*
            const tocTargetDiv = document.getElementById('dynamic-toc-content');

            if (typeof window.envConfig === 'undefined') {
                if (tocTargetDiv) {
                    tocTargetDiv.innerHTML = '<p style="color: red; font-weight: bold;">Critical Error: The environment configuration file (src/env-config.js) failed to load. This may be due to a server error (e.g., file not found, incorrect MIME type for JavaScript) or a syntax error in the file itself. The application cannot proceed reliably. Please check the browser console for errors related to \'src/env-config.js\'.</p>';
                } else {
                    console.error('Error: Target div for ToC (dynamic-toc-content) not found, and envConfig also failed to load.');
                }
                const searchInput = document.getElementById('toc-search');
                if(searchInput) searchInput.disabled = true;
                const homeContentDiv = document.getElementById('home-content');
                if(homeContentDiv) homeContentDiv.innerHTML = '<p style="padding:20px; color:red;">Content loading suspended due to configuration error.</p>';

            } else {
                // envConfig is loaded, proceed to load TOC
                if (tocTargetDiv) {
                    fetch('toc.html')
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok for toc.html: ' + response.status + ' ' + response.statusText);
                            }
                            return response.text();
                        })
                        .then(html => {
                            tocTargetDiv.innerHTML = html;
                            // Add event delegation for ToC links AFTER content is loaded
                            tocTargetDiv.addEventListener('click', function(event) {
                                let targetElement = event.target;
                                // Traverse up the DOM to find an anchor tag if the click was on a child element (e.g., <span> inside <a>)
                                while (targetElement && targetElement !== this && targetElement.tagName !== 'A') {
                                    targetElement = targetElement.parentElement;
                                }

                                if (targetElement && targetElement.tagName === 'A' && targetElement.hasAttribute('href')) {
                                    event.preventDefault(); // Prevent full page navigation
                                    const pageUrl = targetElement.getAttribute('href'); 
                                    if (pageUrl) {
                                        // Call the existing function designed for ToC links
                                        window.loadContentIntoIframe(pageUrl, targetElement);
                                    }
                                }
                            });
                        })
                        .catch(error => {
                            console.error('Error loading Table of Contents:', error);
                            if (tocTargetDiv) {
                               tocTargetDiv.innerHTML = '<p style="color: red;">Error loading Table of Contents. See console for details.</p>';
                            }
                        });
                } else {
                    console.error('Error: Target div for ToC (dynamic-toc-content) not found.');
                }
                
                // Initial page load logic
                const lastPage = sessionStorage.getItem('currentPage');
                if (lastPage) {
                    window.loadContent(lastPage, null); 
                } else {
                    // Wait for TOC to potentially load to find the intro link
                    // A slight delay or a more robust check might be needed if toc.html fetch is slow
                    // For now, assuming querySelector will find it if toc.html is processed quickly
                    setTimeout(() => { // Adding a minimal delay to allow TOC to render
                        const introLink = document.querySelector('#dynamic-toc-content a[href*="introduction/page.html"]');
                        if (introLink && introLink.href) {
                            window.loadContentIntoIframe(introLink.getAttribute('href'), introLink);
                        } else {
                             window.loadContent('EXPRESS/introduction/page.html', null); // Fallback if introLink not found
                        }
                    }, 100); // 100ms delay, adjust as needed or use MutationObserver for robustness
                }
            }
            */
            // Sidebar Toggle Functionality
            const sidebar = document.getElementById('sidebar');
            const toggleButton = document.getElementById('sidebar-toggle-btn');
            if (sidebar && toggleButton) {
                const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
                if (isCollapsed) {
                    document.body.classList.add('sidebar-collapsed');
                    sidebar.classList.add('sidebar-collapsed');
                }

                toggleButton.addEventListener('click', function() {
                    sidebar.classList.toggle('sidebar-collapsed');
                    document.body.classList.toggle('sidebar-collapsed');
                    localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('sidebar-collapsed'));
                });
            } else {
                console.error('Sidebar or toggle button element not found. Toggle functionality will not work.');
            }

            // TOC Search Functionality
            const searchInput = document.getElementById('toc-search');
            const tocContentDiv = document.getElementById('dynamic-toc-content');

            searchInput.addEventListener('input', function(event) {
                const searchTerm = event.target.value.toUpperCase();

                if (!tocContentDiv.querySelector('ul')) {
                    return; 
                }

                const allTopLevelLi = tocContentDiv.querySelectorAll(':scope > ul > li');

                allTopLevelLi.forEach(mainLi => {
                    let mainLiVisible = false;
                    const mainLink = mainLi.querySelector(':scope > a, :scope > span'); 
                    
                    if (mainLink && mainLink.textContent.toUpperCase().includes(searchTerm)) {
                        mainLiVisible = true;
                    }

                    const subUl = mainLi.querySelector(':scope > ul');
                    let hasVisibleSubItem = false;
                    if (subUl) {
                        const allSubLevelLi = subUl.querySelectorAll(':scope > li');
                        allSubLevelLi.forEach(subLi => {
                            const subLink = subLi.querySelector(':scope > a');
                            if (subLink && subLink.textContent.toUpperCase().includes(searchTerm)) {
                                subLi.style.display = ''; 
                                hasVisibleSubItem = true;
                            } else {
                                subLi.style.display = 'none'; 
                            }
                        });
                    }

                    if (mainLiVisible || hasVisibleSubItem) {
                        mainLi.style.display = ''; 
                        if (subUl) subUl.style.display = ''; 
                    } else {
                        mainLi.style.display = 'none'; 
                    }
                });
            });

            // Ensure iframe gets theme on initial load if it's already there
            // This is a bit redundant if loadContent also triggers it, but good for safety
            const contentIframe = document.querySelector('#home-content iframe');
            if (contentIframe && contentIframe.contentWindow) {
                 const currentTheme = localStorage.getItem('theme') || 'light';
                 contentIframe.onload = function() { // Ensure iframe is loaded before sending message
                    contentIframe.contentWindow.postMessage({ type: 'themeChange', theme: currentTheme }, '*');
                 };
                 // If iframe is already loaded (e.g. navigating back), send message directly
                 if (contentIframe.contentDocument && contentIframe.contentDocument.readyState === 'complete') {
                    contentIframe.contentWindow.postMessage({ type: 'themeChange', theme: currentTheme }, '*');
                 }
            }
        });
    </script>
    <script type="module">
      async function loadConfigAndInitialize() {
        const tocTargetDiv = document.getElementById('dynamic-toc-content');
        const homeContentDiv = document.getElementById('home-content');
        const searchInput = document.getElementById('toc-search');
        // const initialLoadLogicContainer = document.getElementById('initial-page-load-logic-container'); // Assuming you move initial load logic here

        function showFatalError(message) {
          if (tocTargetDiv) tocTargetDiv.innerHTML = `<p style="color: red; font-weight: bold;">${message}</p>`;
          if (homeContentDiv) homeContentDiv.innerHTML = `<p style="padding:20px; color:red;">Application failed to initialize: ${message}</p>`;
          if (searchInput) searchInput.disabled = true;
          // Consider disabling other interactive elements too, like theme toggle
          const themeToggleButton = document.getElementById('theme-toggle-btn');
          if (themeToggleButton) themeToggleButton.disabled = true;
        }

        try {
          // Load environment configuration
          const configModule = await import('./src/env-config.js'); 
          window.envConfig = configModule.default; 
          console.log('env-config.js loaded successfully via dynamic import:', window.envConfig);

          // Initialize AutoStorage (without complex router)
          try {
            const autoStorageModule = await import('./src/auto-storage.js');
            
            // Initialize auto-storage (it's a singleton instance)
            window.autoStorage = autoStorageModule.default;
            if (!window.autoStorage.initialized) {
              await window.autoStorage.init();
            }
            
            console.log('AutoStorage initialized successfully');
          } catch (error) {
            console.error('Failed to initialize AutoStorage:', error);
          }

          // Load Quality Control for testing (optional, non-blocking)
          try {
            const qcModule = await import('./src/quality-control.js');
            window.qualityController = new qcModule.default();
            
            // Show QC container in collapsed state on load
            const qcContainer = document.getElementById('qc-report-container');
            if (qcContainer) {
              qcContainer.style.display = 'block';
            }
            
            // Run QC tests in background and update the collapsible UI
            setTimeout(() => {
              window.qualityController.runAllTests().then(() => {
                window.qualityController.updateCollapsibleReport();
                console.log('Quality Control tests completed');
              }).catch(e => console.warn('QC tests failed:', e));
            }, 2000); // Delay to let other components initialize
          } catch (error) {
            console.warn('Quality Control module failed to load:', error);
          }

          // Clear any previous error shown in TOC area if it was there from a different script
          if (tocTargetDiv && tocTargetDiv.innerHTML.includes("Critical Error")) {
            tocTargetDiv.innerHTML = '<p>Loading Table of Contents...</p>'; 
          }
          if (searchInput) searchInput.disabled = false;
          const themeToggleButton = document.getElementById('theme-toggle-btn');
          if (themeToggleButton) themeToggleButton.disabled = false;
          
          // ----- Start: TOC and Initial Page Load Logic -----
          if (tocTargetDiv) {
            fetch('toc.html')
              .then(response => {
                if (!response.ok) {
                  throw new Error('Network response was not ok for toc.html: ' + response.status + ' ' + response.statusText);
                }
                return response.text();
              })
              .then(html => {
                tocTargetDiv.innerHTML = html;
                tocTargetDiv.addEventListener('click', function(event) {
                  let targetElement = event.target;
                  while (targetElement && targetElement !== this && targetElement.tagName !== 'A') {
                    targetElement = targetElement.parentElement;
                  }
                  if (targetElement && targetElement.tagName === 'A' && targetElement.hasAttribute('href')) {
                    event.preventDefault();
                    const pageUrl = targetElement.getAttribute('href');
                    if (pageUrl) {
                      window.loadContentIntoIframe(pageUrl, targetElement);
                    }
                  }
                });

                // Enhanced initial page load logic
                setTimeout(async () => {
                  console.log('üöÄ Starting initial content load...');
                  
                  // First try URL routing
                  const handled = await handleRouting();
                  if (handled) {
                    console.log('‚úÖ Content loaded via URL routing');
                    return;
                  }
                  
                  // Then try session storage
                  const lastPage = sessionStorage.getItem('currentPage');
                  if (lastPage) {
                    console.log('üîÑ Loading last viewed page:', lastPage);
                    const success = await window.loadContent(lastPage, null);
                    if (success) {
                      console.log('‚úÖ Content loaded from session storage');
                      return;
                    }
                  }
                  
                  // Try to find introduction link in TOC
                  const introLink = document.querySelector('#dynamic-toc-content a[href*="introduction/page.html"]');
                  if (introLink && introLink.href) {
                    console.log('üîÑ Loading introduction from TOC');
                    window.loadContentIntoIframe(introLink.getAttribute('href'), introLink);
                    return;
                  }
                  
                  // Fallback to hardcoded introduction page
                  console.log('üîÑ Loading fallback introduction page');
                  const success = await window.loadContent('EXPRESS/introduction/page.html', null);
                  if (success) {
                    console.log('‚úÖ Fallback introduction loaded');
                    return;
                  }
                  
                  // Last resort - try any working page
                  const fallbackPages = [
                    'EXPRESS/section/page.html',
                    'EXPRESS/career/index.html',
                    'EXPRESS/comprehensive-storage-test/index.html'
                  ];
                  
                  for (const page of fallbackPages) {
                    console.log('üîÑ Trying fallback page:', page);
                    const success = await window.loadContent(page, null);
                    if (success) {
                      console.log('‚úÖ Fallback page loaded:', page);
                      return;
                    }
                  }
                  
                  // If all else fails, show a helpful message
                  console.warn('‚ö†Ô∏è No content could be loaded, showing help message');
                  const homeContentDiv = document.getElementById('home-content');
                  if (homeContentDiv) {
                    homeContentDiv.innerHTML = `
                      <div style="padding: 40px; text-align: center; font-family: Arial, sans-serif;">
                        <h2>Welcome to TEST_PROJECT</h2>
                        <p>Click any item in the Table of Contents on the left to view content.</p>
                        <button onclick="location.reload()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Refresh Page</button>
                      </div>
                    `;
                  }
                }, 100); // Short delay to ensure TOC is loaded
              })
              .catch(error => {
                console.error('Error loading Table of Contents:', error);
                if (tocTargetDiv) {
                   tocTargetDiv.innerHTML = '<p style="color: red;">Error loading Table of Contents. Details: ' + error.message + '</p>';
                }
                 // If TOC fails, home content should also reflect an error or stop
                if (homeContentDiv) homeContentDiv.innerHTML = '<p style="padding:20px; color:red;">Content loading suspended due to TOC error.</p>';
              });
          } else {
            console.error('Error: Target div for ToC (dynamic-toc-content) not found.');
            showFatalError('UI component for Table of Contents is missing.');
          }
          // ----- End: TOC and Initial Page Load Logic -----

        } catch (error) {
          console.error('Fatal Error: Failed to load or process src/env-config.js.', error);
          // Check if the error is due to fetch returning HTML (like a 404 page)
          if (error instanceof SyntaxError && error.message.toLowerCase().includes("unexpected token '<'")) {
            showFatalError('Failed to load critical configuration (env-config.js). The server returned HTML instead of JavaScript. This often means the file was not found (404 error) or the server is misconfigured. Please check the file path and server settings.');
          } else {
            showFatalError('Failed to load critical configuration (env-config.js). Details: ' + error.message);
          }
        }
      }
      
      // Run initialization
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadConfigAndInitialize);
      } else {
        // DOMContentLoaded has already fired, run now.
        // This path might be taken if this script itself is deferred or placed very late.
        loadConfigAndInitialize();
      }

      // Add QC Report toggle functionality
      document.addEventListener('DOMContentLoaded', function() {
        const qcHeader = document.getElementById('qc-report-header');
        const qcContent = document.getElementById('qc-report-content');
        const qcToggleIcon = document.getElementById('qc-toggle-icon');
        
        if (qcHeader && qcContent && qcToggleIcon) {
          qcHeader.addEventListener('click', function() {
            const isVisible = qcContent.style.display !== 'none';
            qcContent.style.display = isVisible ? 'none' : 'block';
            qcToggleIcon.style.transform = isVisible ? 'rotate(0deg)' : 'rotate(180deg)';
          });
        }
      });

      // Enhanced global error handler to prevent script execution errors from breaking the app
      window.addEventListener('error', function(event) {
        const errorMsg = event.message || '';
        const fileName = event.filename || '';
        
        // Suppress "Unexpected token '<'" errors (HTML being executed as JS)
        if (errorMsg.includes('Unexpected token') || errorMsg.includes('Unexpected end of input')) {
          console.warn('üîá Suppressed script execution error:', errorMsg, 'at', fileName, event.lineno);
          event.preventDefault();
          return true;
        }
        
        // Suppress cross-origin iframe errors
        if (errorMsg.includes('Script error') || errorMsg.includes('cross-origin')) {
          console.warn('üîá Suppressed cross-origin error:', errorMsg);
          event.preventDefault();
          return true;
        }
        
        // Suppress module loading errors that don't affect functionality
        if (errorMsg.includes('Failed to fetch dynamically imported module') || errorMsg.includes('Loading chunk')) {
          console.warn('üîá Suppressed module loading error:', errorMsg);
          event.preventDefault();
          return true;
        }
        
        // Log other errors normally but don't break the app
        console.error('‚ö†Ô∏è Application error:', errorMsg, 'at', fileName, event.lineno);
        return false;
      });

      // Enhanced promise rejection handler
      window.addEventListener('unhandledrejection', function(event) {
        const reason = event.reason || {};
        const reasonMsg = reason.message || reason.toString();
        
        if (reasonMsg.includes('Loading CSS chunk') || 
            reasonMsg.includes('Loading chunk') ||
            reasonMsg.includes('Failed to fetch dynamically imported module')) {
          console.warn('üîá Suppressed promise rejection:', reasonMsg);
          event.preventDefault();
          return true;
        }
        
        console.warn('‚ö†Ô∏è Promise rejection:', reasonMsg);
        return false;
      });
    </script>
</body>
</html>
